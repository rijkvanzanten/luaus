<%- include partials/head %>
<body class="controller">
  <% if(player) { %>
    <div class="back" style="background-color: rgb(<%= player.color[1] %>, <%= player.color[0] %>, <%= player.color[2] %>)"></div>
  <% } %>

  <% if (!player) { %>
  <form method="POST" action="/controller">
    <label>Enter your name:
      <input type="text" name="name" />
    </label>
    <button type="submit">Join game!</button>
  </form>
  <% } else { %>
    <h1><%= name %></h1>
    <button id="bigredbutton"></button>
  <% } %>
</body>

<script>
  const ws = new WebSocket('ws://' + location.hostname + ':' + location.port);
  const btn = document.querySelector('#bigredbutton');
  const btnID = document.querySelector('h1').innerText;

  ws.addEventListener('open', onOpenSocket);
  ws.addEventListener('message', onSocketMessage);

  btn.addEventListener('click', updateScore);

  function onOpenSocket() {
    console.log('Socket connected');
    btn.disabled = true;
  }

  function onSocketMessage(event) {
    const data = JSON.parse(event.data);

    switch (data.action) {
      case 'START_GAME':
        btn.disabled = false;
        break;
      case 'END_GAME':
        btn.disabled = true;
        // btn.removeEventListener('click', updateScore);

        if (btnID !== data.winner.id) {
          document.querySelector('.controller').classList.add('lost');
        }
        break;
      default:
        return false;
    }
  }

  function updateScore() {
    ws.send(
      JSON.stringify({
        device: 'phone',
        action: 'UPDATE_SCORE',
        id: btnID
      })
    )
  }
</script>
